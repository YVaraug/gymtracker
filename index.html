<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GymTracker - Seguimiento de Entrenamientos</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-dumbbell"></i> GymTracker</h1>
            <p>Tu compañero personal para el seguimiento de entrenamientos</p>
        </div>

        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('profile')">
                <i class="fas fa-user"></i> Perfil
            </div>
            <div class="nav-tab" onclick="showTab('workout')">
                <i class="fas fa-play"></i> Entrenar
            </div>
            <div class="nav-tab" onclick="showTab('goals')">
                <i class="fas fa-bullseye"></i> Objetivos
            </div>
            <div class="nav-tab" onclick="showTab('history')">
                <i class="fas fa-history"></i> Historial
            </div>
            <div class="nav-tab" onclick="showTab('stats')">
                <i class="fas fa-chart-bar"></i> Estadísticas
            </div>
        </div>

        <!-- Perfil -->
        <div id="profile" class="tab-content active">
            <h2><i class="fas fa-user"></i> Mi Perfil</h2>
            <form id="profileForm">
                <div class="form-group">
                    <label for="firstName">Nombre</label>
                    <input type="text" id="firstName" class="form-control" placeholder="Tu nombre">
                </div>
                <div class="form-group">
                    <label for="lastName">Apellidos</label>
                    <input type="text" id="lastName" class="form-control" placeholder="Tus apellidos">
                </div>
                <div class="form-group">
                    <label for="weight">Peso (kg)</label>
                    <input type="number" id="weight" class="form-control" placeholder="Tu peso en kg">
                </div>
                <div class="form-group">
                    <label for="height">Altura (cm)</label>
                    <input type="number" id="height" class="form-control" placeholder="Tu altura en cm">
                </div>
                <div class="form-group">
                    <label for="gender">Género</label>
                    <select id="gender" class="form-control">
                        <option value="">Selecciona tu género</option>
                        <option value="Male">Masculino</option>
                        <option value="Female">Femenino</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="level">Nivel de entrenamiento</label>
                    <select id="level" class="form-control">
                        <option value="">Selecciona tu nivel</option>
                        <option value="Beginner">Principiante</option>
                        <option value="Novice">Novato</option>
                        <option value="Intermediate">Intermedio</option>
                        <option value="Advanced">Avanzado</option>
                        <option value="Elite">Élite</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Guardar Perfil
                </button>
            </form>
        </div>

        <!-- Entrenamiento -->
        <div id="workout" class="tab-content">
            <h2><i class="fas fa-play"></i> Iniciar Entrenamiento</h2>
            
            <div id="workoutStart" class="workout-summary">
                <h3>¿Listo para entrenar?</h3>
                <p>Fecha y hora actual: <span id="currentDateTime"></span></p>
                <button class="btn btn-success" onclick="startWorkout()">
                    <i class="fas fa-play"></i> Iniciar Entrenamiento
                </button>
            </div>

            <div id="workoutActive" style="display: none;">
                <div class="workout-summary">
                    <h3>Entrenamiento en curso</h3>
                    <p>Iniciado: <span id="workoutStartTime"></span></p>
                    <button class="btn btn-danger" onclick="finishWorkout()">
                        <i class="fas fa-stop"></i> Finalizar Entrenamiento
                    </button>
                </div>

                <div class="exercise-selector">
                    <label for="exerciseSearch">Buscar ejercicio:</label>
                    <div class="search-filters">
                        <select id="bodyPartFilter" class="filter-select">
                            <option value="">Todos los grupos musculares</option>
                            <option value="Back">Espalda</option>
                            <option value="Biceps">Bíceps</option>
                            <option value="Chest">Pecho</option>
                            <option value="Core">Core</option>
                            <option value="Forearm">Antebrazos</option>
                            <option value="Legs">Piernas</option>
                            <option value="Shoulder">Hombros</option>
                            <option value="Triceps">Tríceps</option>
                        </select>
                        <select id="equipmentFilter" class="filter-select">
                            <option value="">Todo el equipo</option>
                            <option value="Barbell">Barra</option>
                            <option value="Body Weight">Peso corporal</option>
                            <option value="Dumbbell">Mancuernas</option>
                        </select>
                    </div>
                    <input type="text" id="exerciseSearch" class="exercise-search" placeholder="Escribe para buscar ejercicios...">
                    <div id="exerciseDropdown" class="exercise-dropdown"></div>
                </div>

                <div id="exercisesList"></div>

                <div class="rest-timer" id="restTimer" style="display: none;">
                    <h3>Descanso</h3>
                    <div class="timer-display" id="timerDisplay">00:00</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <button class="btn btn-secondary" onclick="skipRest()">Saltar descanso</button>
                </div>
            </div>
        </div>

        <!-- Historial -->
        <div id="history" class="tab-content">
            <h2><i class="fas fa-history"></i> Historial de Entrenamientos</h2>
            <div id="workoutHistory"></div>
        </div>

        <!-- Objetivos -->
        <div id="goals" class="tab-content">
            <h2><i class="fas fa-bullseye"></i> Mis Objetivos</h2>
            
            <div class="form-group">
                <label for="goalExercise">Ejercicio:</label>
                <div class="exercise-selector">
                    <div class="search-filters">
                        <select id="goalBodyPartFilter" class="filter-select">
                            <option value="">Todos los grupos musculares</option>
                            <option value="Back">Espalda</option>
                            <option value="Biceps">Bíceps</option>
                            <option value="Chest">Pecho</option>
                            <option value="Core">Core</option>
                            <option value="Forearm">Antebrazos</option>
                            <option value="Legs">Piernas</option>
                            <option value="Shoulder">Hombros</option>
                            <option value="Triceps">Tríceps</option>
                        </select>
                        <select id="goalEquipmentFilter" class="filter-select">
                            <option value="">Todo el equipo</option>
                            <option value="Barbell">Barra</option>
                            <option value="Body Weight">Peso corporal</option>
                            <option value="Dumbbell">Mancuernas</option>
                        </select>
                    </div>
                    <input type="text" id="goalExercise" class="exercise-search" placeholder="Buscar ejercicio...">
                    <div id="goalExerciseDropdown" class="exercise-dropdown"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="goalType">Tipo de objetivo:</label>
                <select id="goalType" class="form-control">
                    <option value="weight">Peso máximo (1RM)</option>
                    <option value="reps">Repeticiones con peso específico</option>
                    <option value="volume">Volumen total</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="goalValue">Valor objetivo:</label>
                <input type="number" id="goalValue" class="form-control" placeholder="Ej: 100 kg o 10 reps">
            </div>
            
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="trackMe" style="margin: 0;">
                    <span>Track me (seguir progreso por niveles)</span>
                </label>
                <small style="color: #666; display: block; margin-top: 5px;">
                    Si está marcado, el progreso se mostrará dividido en niveles según tu peso corporal y género
                </small>
            </div>
            
            <button class="btn btn-primary" onclick="addGoal()">
                <i class="fas fa-plus"></i> Añadir Objetivo
            </button>
            
            <div id="goalsList" style="margin-top: 30px;">
                <h3>Mis Objetivos Actuales</h3>
                <div id="goalsContainer"></div>
            </div>
        </div>

        <!-- Estadísticas -->
        <div id="stats" class="tab-content">
            <h2><i class="fas fa-chart-bar"></i> Estadísticas</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalWorkouts">0</div>
                    <div class="stat-label">Entrenamientos totales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="monthWorkouts">0</div>
                    <div class="stat-label">Este mes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="weekWorkouts">0</div>
                    <div class="stat-label">Esta semana</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalExercises">0</div>
                    <div class="stat-label">Ejercicios realizados</div>
                </div>
            </div>

            <div class="form-group">
                <label for="statsPeriod">Período de estadísticas:</label>
                <select id="statsPeriod" class="form-control" onchange="updateStats()">
                    <option value="week">Esta semana</option>
                    <option value="month">Este mes</option>
                    <option value="year">Este año</option>
                </select>
            </div>

            <div id="exerciseStats"></div>
        </div>
    </div>

    <script>
        // Variables globales
        let exercises = [];
        let currentWorkout = null;
        let workoutHistory = [];
        let userProfile = {};
        let restTimer = null;
        let restTime = 0;
        let restStartTime = null;
        let goals = [];
        let currentRest = null;

        // Verificar archivos disponibles
        async function checkFiles() {
            try {
                const response = await fetch('exerciseData.csv', { method: 'HEAD' });
                return response.ok;
            } catch (error) {
                console.log('Archivo CSV no encontrado:', error);
                return false;
            }
        }

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Iniciando GymTracker...');
            
            // Verificar si estamos en un servidor local
            const isLocalServer = window.location.protocol === 'http:' || window.location.protocol === 'https:';
            const csvAvailable = await checkFiles();
            
            console.log('Protocolo:', window.location.protocol);
            console.log('CSV disponible:', csvAvailable);
            
            if (!isLocalServer) {
                console.warn('⚠️ Abriendo archivo directamente. Para mejor compatibilidad, usa un servidor local.');
                document.body.insertAdjacentHTML('afterbegin', `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin: 10px; border-radius: 5px; text-align: center;">
                        <strong>⚠️ Aviso:</strong> Para mejor compatibilidad, usa un servidor local. 
                        Ejecuta <code>python -m http.server 8000</code> y ve a <code>http://localhost:8000</code>
                    </div>
                `);
            }
            
            loadExercises();
            loadProfile();
            loadWorkoutHistory();
            loadGoals();
            updateDateTime();
            setInterval(updateDateTime, 1000);
        });

        // Navegación entre pestañas
        function showTab(tabName) {
            // Ocultar todas las pestañas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar pestaña seleccionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Actualizar contenido específico
            if (tabName === 'history') {
                displayWorkoutHistory();
            } else if (tabName === 'stats') {
                updateStats();
            } else if (tabName === 'goals') {
                displayGoals();
            }
        }

        // Actualizar fecha y hora
        function updateDateTime() {
            const now = new Date();
            const dateTimeString = now.toLocaleString('es-ES');
            document.getElementById('currentDateTime').textContent = dateTimeString;
        }

        // Cargar ejercicios desde CSV
        async function loadExercises() {
            try {
                console.log('Intentando cargar ejercicios...');
                const response = await fetch('exerciseData.csv');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('CSV cargado, procesando...');
                
                if (!csvText || csvText.trim() === '') {
                    throw new Error('El archivo CSV está vacío');
                }
                
                const lines = csvText.split('\n');
                console.log(`Total de líneas en CSV: ${lines.length}`);
                
                // Saltar la primera línea (headers)
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i];
                    if (line.trim()) {
                        const values = line.split('","');
                        if (values.length >= 8) {
                            const exercise = {
                                id: values[0].replace(/"/g, ''),
                                name: values[1].replace(/"/g, ''),
                                image: values[2].replace(/"/g, ''),
                                level: values[3].replace(/"/g, ''),
                                reps: values[4].replace(/"/g, ''),
                                gender: values[5].replace(/"/g, ''),
                                bodyPart: values[6].replace(/"/g, ''),
                                equipment: values[7].replace(/"/g, '')
                            };
                            exercises.push(exercise);
                        }
                    }
                }
                console.log(`Cargados ${exercises.length} ejercicios exitosamente`);
                
                // Mostrar mensaje de éxito
                const workoutTab = document.querySelector('.nav-tab[onclick="showTab(\'workout\')"]');
                if (workoutTab) {
                    workoutTab.innerHTML = '<i class="fas fa-play"></i> Entrenar';
                }
                
            } catch (error) {
                console.error('Error cargando ejercicios:', error);
                console.log('Cargando ejercicios de respaldo...');
                
                // Cargar ejercicios básicos como respaldo
                exercises = [
                    {
                        id: "1",
                        name: "Bench Press",
                        image: "https://static.strengthlevel.com/images/silhouettes/bench-press-256x256.png",
                        level: "Intermediate",
                        reps: "1.25x",
                        gender: "Male",
                        bodyPart: "Chest",
                        equipment: "Barbell"
                    },
                    {
                        id: "2",
                        name: "Squat",
                        image: "https://static.strengthlevel.com/images/silhouettes/barbell-squat-256x256.png",
                        level: "Intermediate",
                        reps: "1.25x",
                        gender: "Male",
                        bodyPart: "Legs",
                        equipment: "Barbell"
                    },
                    {
                        id: "3",
                        name: "Deadlift",
                        image: "https://static.strengthlevel.com/images/silhouettes/deadlift-256x256.png",
                        level: "Intermediate",
                        reps: "1.25x",
                        gender: "Male",
                        bodyPart: "Back",
                        equipment: "Barbell"
                    },
                    {
                        id: "4",
                        name: "Pull Ups",
                        image: "https://static.strengthlevel.com/images/silhouettes/pull-ups-256x256.png",
                        level: "Intermediate",
                        reps: "14",
                        gender: "Male",
                        bodyPart: "Back",
                        equipment: "Body Weight"
                    },
                    {
                        id: "5",
                        name: "Push Ups",
                        image: "https://static.strengthlevel.com/images/silhouettes/push-ups-256x256.png",
                        level: "Intermediate",
                        reps: "41",
                        gender: "Male",
                        bodyPart: "Chest",
                        equipment: "Body Weight"
                    },
                    {
                        id: "6",
                        name: "Dumbbell Curl",
                        image: "https://static.strengthlevel.com/images/silhouettes/dumbbell-curl-256x256.png",
                        level: "Intermediate",
                        reps: "0.30x",
                        gender: "Male",
                        bodyPart: "Biceps",
                        equipment: "Dumbbell"
                    }
                ];
                
                console.log(`Cargados ${exercises.length} ejercicios de respaldo`);
                
                // Mostrar mensaje de éxito con advertencia
                const workoutTab = document.querySelector('.nav-tab[onclick="showTab(\'workout\')"]');
                if (workoutTab) {
                    workoutTab.innerHTML = '<i class="fas fa-play"></i> Entrenar';
                }
                
                // Mostrar advertencia
                document.getElementById('workout').insertAdjacentHTML('afterbegin', `
                    <div style="background: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; margin-bottom: 20px; border-radius: 10px;">
                        <h4><i class="fas fa-info-circle"></i> Modo de respaldo activado</h4>
                        <p>Se cargaron ejercicios básicos porque no se pudo acceder al archivo CSV completo.</p>
                        <p><strong>Para usar todos los ejercicios:</strong></p>
                        <ol>
                            <li>Usa un servidor local: <code>python -m http.server 8000</code></li>
                            <li>Ve a <code>http://localhost:8000</code></li>
                        </ol>
                    </div>
                `);
            }
        }

        // Función para filtrar ejercicios
        function filterExercises(searchTerm, bodyPartFilter, equipmentFilter, exercises) {
            const exerciseMap = new Map();
            exercises.forEach(exercise => {
                // Filtrar por término de búsqueda
                const matchesSearch = !searchTerm || searchTerm.length < 2 || 
                    exercise.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    exercise.bodyPart.toLowerCase().includes(searchTerm.toLowerCase());
                
                // Filtrar por grupo muscular
                const matchesBodyPart = !bodyPartFilter || exercise.bodyPart === bodyPartFilter;
                
                // Filtrar por equipo
                const matchesEquipment = !equipmentFilter || exercise.equipment === equipmentFilter;
                
                if (matchesSearch && matchesBodyPart && matchesEquipment) {
                    if (!exerciseMap.has(exercise.name)) {
                        exerciseMap.set(exercise.name, exercise);
                    }
                }
            });
            
            return Array.from(exerciseMap.values()).slice(0, 10);
        }

        // Búsqueda de ejercicios
        document.getElementById('exerciseSearch').addEventListener('input', function() {
            const searchTerm = this.value;
            const bodyPartFilter = document.getElementById('bodyPartFilter').value;
            const equipmentFilter = document.getElementById('equipmentFilter').value;
            const dropdown = document.getElementById('exerciseDropdown');
            
            const uniqueExercises = filterExercises(searchTerm, bodyPartFilter, equipmentFilter, exercises);

            dropdown.innerHTML = '';
            uniqueExercises.forEach(exercise => {
                const option = document.createElement('div');
                option.className = 'exercise-option';
                option.innerHTML = `
                    <img src="${exercise.image}" alt="${exercise.name}" onerror="this.src='https://via.placeholder.com/40x40?text=?'">
                    <div>
                        <div><strong>${exercise.name}</strong></div>
                        <div style="font-size: 12px; color: #666;">${exercise.bodyPart} - ${exercise.equipment}</div>
                    </div>
                `;
                option.onclick = () => addExerciseToWorkout(exercise);
                dropdown.appendChild(option);
            });
            
            dropdown.style.display = uniqueExercises.length > 0 ? 'block' : 'none';
        });

        // Event listeners para los filtros
        document.getElementById('bodyPartFilter').addEventListener('change', function() {
            const searchTerm = document.getElementById('exerciseSearch').value;
            const equipmentFilter = document.getElementById('equipmentFilter').value;
            const dropdown = document.getElementById('exerciseDropdown');
            
            const uniqueExercises = filterExercises(searchTerm, this.value, equipmentFilter, exercises);

            dropdown.innerHTML = '';
            uniqueExercises.forEach(exercise => {
                const option = document.createElement('div');
                option.className = 'exercise-option';
                option.innerHTML = `
                    <img src="${exercise.image}" alt="${exercise.name}" onerror="this.src='https://via.placeholder.com/40x40?text=?'">
                    <div>
                        <div><strong>${exercise.name}</strong></div>
                        <div style="font-size: 12px; color: #666;">${exercise.bodyPart} - ${exercise.equipment}</div>
                    </div>
                `;
                option.onclick = () => addExerciseToWorkout(exercise);
                dropdown.appendChild(option);
            });
            
            dropdown.style.display = uniqueExercises.length > 0 ? 'block' : 'none';
        });

        document.getElementById('equipmentFilter').addEventListener('change', function() {
            const searchTerm = document.getElementById('exerciseSearch').value;
            const bodyPartFilter = document.getElementById('bodyPartFilter').value;
            const dropdown = document.getElementById('exerciseDropdown');
            
            const uniqueExercises = filterExercises(searchTerm, bodyPartFilter, this.value, exercises);

            dropdown.innerHTML = '';
            uniqueExercises.forEach(exercise => {
                const option = document.createElement('div');
                option.className = 'exercise-option';
                option.innerHTML = `
                    <img src="${exercise.image}" alt="${exercise.name}" onerror="this.src='https://via.placeholder.com/40x40?text=?'">
                    <div>
                        <div><strong>${exercise.name}</strong></div>
                        <div style="font-size: 12px; color: #666;">${exercise.bodyPart} - ${exercise.equipment}</div>
                    </div>
                `;
                option.onclick = () => addExerciseToWorkout(exercise);
                dropdown.appendChild(option);
            });
            
            dropdown.style.display = uniqueExercises.length > 0 ? 'block' : 'none';
        });

        // Cerrar dropdown al hacer clic fuera
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.exercise-selector')) {
                document.getElementById('exerciseDropdown').style.display = 'none';
                document.getElementById('goalExerciseDropdown').style.display = 'none';
            }
        });

        // Agregar ejercicio al entrenamiento
        function addExerciseToWorkout(exercise) {
            if (!currentWorkout) return;

            const exerciseCard = document.createElement('div');
            exerciseCard.className = 'exercise-card';
            exerciseCard.innerHTML = `
                <div class="exercise-header">
                    <div class="exercise-name">${exercise.name}</div>
                    <img src="${exercise.image}" alt="${exercise.name}" class="exercise-image" onerror="this.src='https://via.placeholder.com/60x60?text=?'">
                </div>
                <div class="sets-container">
                    <div class="set-item">
                        <div class="set-number">1</div>
                        <input type="number" class="set-input weight-input" placeholder="Peso (kg)" min="0">
                        <input type="number" class="set-input reps-input" placeholder="Repeticiones" min="0" title="Para calcular el 1RM, introduce entre 1 y 10 repeticiones">
                        <button class="btn btn-danger" onclick="removeSet(this)">-</button>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addSet(this)">+ Serie</button>
                <button class="btn btn-secondary" onclick="startRest()">Descanso</button>
                <button class="btn btn-danger" onclick="removeExercise(this)">Eliminar</button>
            `;

            document.getElementById('exercisesList').appendChild(exerciseCard);
            document.getElementById('exerciseSearch').value = '';
            document.getElementById('exerciseDropdown').style.display = 'none';
        }

        // Agregar serie
        function addSet(button) {
            const setsContainer = button.previousElementSibling;
            const setCount = setsContainer.children.length + 1;
            
            const setItem = document.createElement('div');
            setItem.className = 'set-item';
            setItem.innerHTML = `
                <div class="set-number">${setCount}</div>
                <input type="number" class="set-input weight-input" placeholder="Peso (kg)" min="0">
                <input type="number" class="set-input reps-input" placeholder="Repeticiones" min="0" title="Para calcular el 1RM, introduce entre 1 y 10 repeticiones">
                <button class="btn btn-danger" onclick="removeSet(this)">-</button>
            `;
            
            setsContainer.appendChild(setItem);
        }

        // Remover serie
        function removeSet(button) {
            const setItem = button.parentElement;
            const setsContainer = setItem.parentElement;
            
            if (setsContainer.children.length > 1) {
                setItem.remove();
                // Renumerar series
                Array.from(setsContainer.children).forEach((set, index) => {
                    set.querySelector('.set-number').textContent = index + 1;
                });
            }
        }

        // Remover ejercicio
        function removeExercise(button) {
            button.closest('.exercise-card').remove();
        }

        // Iniciar entrenamiento
        function startWorkout() {
            currentWorkout = {
                startTime: new Date(),
                exercises: []
            };
            
            document.getElementById('workoutStart').style.display = 'none';
            document.getElementById('workoutActive').style.display = 'block';
            document.getElementById('workoutStartTime').textContent = currentWorkout.startTime.toLocaleString('es-ES');
        }

        // Finalizar entrenamiento
        function finishWorkout() {
            if (!currentWorkout) return;

            // Recopilar datos del entrenamiento
            const exerciseCards = document.querySelectorAll('.exercise-card');
            let invalidReps = false;
            exerciseCards.forEach(card => {
                if (invalidReps) return;
                const exerciseName = card.querySelector('.exercise-name').textContent;
                const sets = [];

                card.querySelectorAll('.set-item').forEach(setItem => {
                    if (invalidReps) return;
                    const weight = setItem.querySelector('.weight-input').value;
                    const reps = setItem.querySelector('.reps-input').value;
                    if (reps) { // Solo verificamos que haya repeticiones
                        const parsedWeight = weight ? parseFloat(weight) : 0; // Si no hay peso, considerar 0
                        const parsedReps = parseInt(reps);
                        if (parsedWeight > 0 && (parsedReps < 1 || parsedReps > 10)) {
                            invalidReps = true;
                            return;
                        }
                        sets.push({
                            weight: parsedWeight,
                            reps: parsedReps
                        });
                    }
                });

                if (invalidReps) return;

                if (sets.length > 0) {
                    // Calcular 1RM estimado para ejercicios con peso
                    let estimated1RM = 0;
                    sets.forEach(set => {
                        if (set.weight > 0 && set.reps >= 1 && set.reps <= 10) {
                            const oneRM = calculate1RM(set.weight, set.reps);
                            if (oneRM && oneRM > estimated1RM) {
                                estimated1RM = oneRM;
                            }
                        }
                    });

                    currentWorkout.exercises.push({
                        name: exerciseName,
                        sets: sets,
                        estimated1RM: estimated1RM > 0 ? estimated1RM : null
                    });
                }
            });

            if (invalidReps) {
                alert('Para calcular el 1RM, introduce entre 1 y 10 repeticiones para series con peso.');
                return;
            }

            currentWorkout.endTime = new Date();
            currentWorkout.duration = Math.round((currentWorkout.endTime - currentWorkout.startTime) / 1000 / 60); // minutos

            // Guardar en historial
            workoutHistory.unshift(currentWorkout);
            localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));

            // Resetear interfaz
            currentWorkout = null;
            document.getElementById('workoutStart').style.display = 'block';
            document.getElementById('workoutActive').style.display = 'none';
            document.getElementById('exercisesList').innerHTML = '';

            alert('¡Entrenamiento guardado exitosamente!');
        }

        // Iniciar descanso
        function startRest() {
            const restMinutes = prompt('¿Cuántos minutos de descanso?', '2');
            if (restMinutes && !isNaN(restMinutes)) {
                restTime = parseInt(restMinutes) * 60;
                restStartTime = new Date();
                currentRest = {
                    name: 'Descanso',
                    duration: restTime,
                    startTime: restStartTime
                };
                showRestTimer();
            }
        }

        // Mostrar timer de descanso
        function showRestTimer() {
            const timerDisplay = document.getElementById('timerDisplay');
            const progressFill = document.getElementById('progressFill');
            const restTimerDiv = document.getElementById('restTimer');
            
            restTimerDiv.style.display = 'block';
            
            let timeLeft = restTime;
            
            restTimer = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const progress = ((restTime - timeLeft) / restTime) * 100;
                progressFill.style.width = `${progress}%`;
                
                timeLeft--;
                
                if (timeLeft < 0) {
                    clearInterval(restTimer);
                    restTimerDiv.style.display = 'none';
                    
                    // Registrar descanso completo
                    if (currentRest && currentWorkout) {
                        currentWorkout.exercises.push({
                            name: 'Descanso',
                            sets: [{
                                weight: 0,
                                reps: Math.round(restTime / 60),
                                isRest: true
                            }]
                        });
                    }
                    
                    currentRest = null;
                    restStartTime = null;
                    alert('¡Tiempo de descanso terminado!');
                }
            }, 1000);
        }

        // Saltar descanso
        function skipRest() {
            if (restTimer) {
                clearInterval(restTimer);
                document.getElementById('restTimer').style.display = 'none';
                
                // Registrar descanso realizado
                if (currentRest && currentWorkout) {
                    const actualDuration = Math.round((new Date() - currentRest.startTime) / 1000 / 60);
                    currentWorkout.exercises.push({
                        name: 'Descanso',
                        sets: [{
                            weight: 0,
                            reps: actualDuration,
                            isRest: true
                        }]
                    });
                }
                
                currentRest = null;
                restStartTime = null;
            }
        }

        // Guardar perfil
        document.getElementById('profileForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            userProfile = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                weight: parseFloat(document.getElementById('weight').value),
                height: parseInt(document.getElementById('height').value),
                gender: document.getElementById('gender').value,
                level: document.getElementById('level').value
            };
            
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            alert('Perfil guardado exitosamente!');
        });

        // Cargar perfil
        function loadProfile() {
            const saved = localStorage.getItem('userProfile');
            if (saved) {
                userProfile = JSON.parse(saved);
                document.getElementById('firstName').value = userProfile.firstName || '';
                document.getElementById('lastName').value = userProfile.lastName || '';
                document.getElementById('weight').value = userProfile.weight || '';
                document.getElementById('height').value = userProfile.height || '';
                document.getElementById('gender').value = userProfile.gender || '';
                document.getElementById('level').value = userProfile.level || '';
            }
        }

        // Cargar historial
        function loadWorkoutHistory() {
            const saved = localStorage.getItem('workoutHistory');
            if (saved) {
                workoutHistory = JSON.parse(saved);
            }
        }

        // Mostrar historial
        function displayWorkoutHistory() {
            const historyContainer = document.getElementById('workoutHistory');
            
            if (workoutHistory.length === 0) {
                historyContainer.innerHTML = '<p>No hay entrenamientos registrados aún.</p>';
                return;
            }
            
            historyContainer.innerHTML = workoutHistory.map((workout, index) => `
                <div class="history-item">
                    <div class="history-date">
                        ${new Date(workout.startTime).toLocaleDateString('es-ES')} - 
                        ${new Date(workout.startTime).toLocaleTimeString('es-ES')}
                        <span style="float: right; color: #666;">${workout.duration} min</span>
                    </div>
                    <div class="history-exercises">
                        <strong>Ejercicios:</strong> ${workout.exercises.filter(ex => ex.name !== 'Descanso').map(ex => ex.name).join(', ')}
                        ${workout.exercises.some(ex => ex.estimated1RM) ? 
                            `<br><strong>1RM destacados:</strong> ${workout.exercises
                                .filter(ex => ex.estimated1RM)
                                .map(ex => `${ex.name}: ${ex.estimated1RM.toFixed(1)}kg`)
                                .join(', ')}` : ''}
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-secondary" onclick="toggleWorkoutDetails(${index})">
                            <i class="fas fa-eye"></i> Ver detalles
                        </button>
                    </div>
                    <div class="workout-details" id="workoutDetails${index}" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4>Detalles del entrenamiento:</h4>
                        <div id="workoutDetailsContent${index}"></div>
                    </div>
                </div>
            `).join('');
        }

        // Alternar detalles del entrenamiento
        function toggleWorkoutDetails(index) {
            const detailsDiv = document.getElementById(`workoutDetails${index}`);
            const contentDiv = document.getElementById(`workoutDetailsContent${index}`);
            const button = event.target.closest('.btn');
            
            if (detailsDiv.style.display === 'none') {
                // Mostrar detalles
                const workout = workoutHistory[index];
                let detailsHTML = '';
                
                workout.exercises.forEach((exercise, exerciseIndex) => {
                    if (exercise.name === 'Descanso') {
                        detailsHTML += `
                            <div style="margin-bottom: 10px; padding: 8px; background: #fff3cd; border-radius: 5px;">
                                <strong>${exercise.name}:</strong> ${exercise.sets[0].reps} minutos
                                <button class="btn btn-sm btn-warning" style="float: right; margin-left: 5px;" onclick="editExercise(${index}, ${exerciseIndex})">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        `;
                    } else {
                        detailsHTML += `
                            <div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 5px; border-left: 3px solid #667eea;">
                                <strong>${exercise.name}:</strong>
                                <button class="btn btn-sm btn-warning" style="float: right; margin-left: 5px;" onclick="editExercise(${index}, ${exerciseIndex})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <div style="margin-top: 5px;">
                        `;
                        
                        exercise.sets.forEach((set, setIndex) => {
                            detailsHTML += `
                                <div style="margin-left: 15px; color: #666;">
                                    Serie ${setIndex + 1}: ${set.weight}kg x ${set.reps} reps
                                </div>
                            `;
                        });
                        
                        if (exercise.estimated1RM) {
                            detailsHTML += `
                                <div style="margin-left: 15px; color: #28a745; font-weight: bold;">
                                    1RM estimado: ${exercise.estimated1RM.toFixed(1)}kg
                                </div>
                            `;
                        }
                        
                        detailsHTML += '</div></div>';
                    }
                });
                
                // Añadir botones de acción al final
                detailsHTML += `
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd; text-align: center;">
                        <button class="btn btn-danger" onclick="deleteWorkout(${index})">
                            <i class="fas fa-trash"></i> Eliminar sesión completa
                        </button>
                    </div>
                `;
                
                contentDiv.innerHTML = detailsHTML;
                detailsDiv.style.display = 'block';
                button.innerHTML = '<i class="fas fa-eye-slash"></i> Ocultar detalles';
            } else {
                // Ocultar detalles
                detailsDiv.style.display = 'none';
                button.innerHTML = '<i class="fas fa-eye"></i> Ver detalles';
            }
        }

        // Eliminar sesión completa
        function deleteWorkout(index) {
            if (confirm('¿Estás seguro de que quieres eliminar esta sesión completa? Esta acción no se puede deshacer.')) {
                workoutHistory.splice(index, 1);
                localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));
                displayWorkoutHistory();
                updateStats();
                alert('Sesión eliminada correctamente.');
            }
        }

        // Editar ejercicio
        function editExercise(workoutIndex, exerciseIndex) {
            const workout = workoutHistory[workoutIndex];
            const exercise = workout.exercises[exerciseIndex];
            
            if (exercise.name === 'Descanso') {
                editRestExercise(workoutIndex, exerciseIndex);
            } else {
                editRegularExercise(workoutIndex, exerciseIndex);
            }
        }

        // Editar ejercicio regular
        function editRegularExercise(workoutIndex, exerciseIndex) {
            const workout = workoutHistory[workoutIndex];
            const exercise = workout.exercises[exerciseIndex];
            
            let setsHTML = '';
            exercise.sets.forEach((set, setIndex) => {
                setsHTML += `
                    <div style="margin-bottom: 10px;">
                        <label>Serie ${setIndex + 1}:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="editWeight${setIndex}" value="${set.weight}" placeholder="Peso (kg)" style="flex: 1;">
                            <input type="number" id="editReps${setIndex}" value="${set.reps}" placeholder="Reps" style="flex: 1;">
                            <button class="btn btn-sm btn-danger" onclick="removeSet(${workoutIndex}, ${exerciseIndex}, ${setIndex})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            const modalHTML = `
                <div id="editModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h3>Editar ${exercise.name}</h3>
                        <div id="editSetsContainer">
                            ${setsHTML}
                        </div>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="addNewSet(${workoutIndex}, ${exerciseIndex})">
                                <i class="fas fa-plus"></i> Añadir Serie
                            </button>
                        </div>
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-success" onclick="saveExerciseEdit(${workoutIndex}, ${exerciseIndex})">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                            <button class="btn btn-secondary" onclick="closeEditModal()" style="margin-left: 10px;">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Editar ejercicio de descanso
        function editRestExercise(workoutIndex, exerciseIndex) {
            const workout = workoutHistory[workoutIndex];
            const exercise = workout.exercises[exerciseIndex];
            const duration = exercise.sets[0].reps;
            
            const modalHTML = `
                <div id="editModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 400px; width: 90%;">
                        <h3>Editar Descanso</h3>
                        <div style="margin-bottom: 20px;">
                            <label>Duración (minutos):</label>
                            <input type="number" id="editRestDuration" value="${duration}" min="1" max="60" style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="text-align: center;">
                            <button class="btn btn-success" onclick="saveRestEdit(${workoutIndex}, ${exerciseIndex})">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                            <button class="btn btn-secondary" onclick="closeEditModal()" style="margin-left: 10px;">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Añadir nueva serie
        function addNewSet(workoutIndex, exerciseIndex) {
            const container = document.getElementById('editSetsContainer');
            const setIndex = container.children.length;
            
            const newSetHTML = `
                <div style="margin-bottom: 10px;">
                    <label>Serie ${setIndex + 1}:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="editWeight${setIndex}" placeholder="Peso (kg)" style="flex: 1;">
                        <input type="number" id="editReps${setIndex}" placeholder="Reps" style="flex: 1;">
                        <button class="btn btn-sm btn-danger" onclick="removeSet(${workoutIndex}, ${exerciseIndex}, ${setIndex})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', newSetHTML);
        }

        // Eliminar serie
        function removeSet(workoutIndex, exerciseIndex, setIndex) {
            const container = document.getElementById('editSetsContainer');
            const sets = container.children;
            
            if (sets.length > 1) {
                sets[setIndex].remove();
                // Renumerar las series restantes
                Array.from(sets).forEach((setDiv, index) => {
                    const label = setDiv.querySelector('label');
                    if (label) label.textContent = `Serie ${index + 1}:`;
                });
            } else {
                alert('Debe haber al menos una serie.');
            }
        }

        // Guardar edición de ejercicio regular
        function saveExerciseEdit(workoutIndex, exerciseIndex) {
            const workout = workoutHistory[workoutIndex];
            const exercise = workout.exercises[exerciseIndex];
            const container = document.getElementById('editSetsContainer');
            const sets = [];
            
            // Recopilar datos de las series
            for (let i = 0; i < container.children.length; i++) {
                const weightInput = document.getElementById(`editWeight${i}`);
                const repsInput = document.getElementById(`editReps${i}`);

                if (weightInput && repsInput) {
                    const weight = parseFloat(weightInput.value) || 0;
                    const reps = parseInt(repsInput.value) || 0;

                    if (weight > 0 && (reps < 1 || reps > 10)) {
                        alert('Para calcular el 1RM, introduce entre 1 y 10 repeticiones para series con peso.');
                        return;
                    }

                    if (weight > 0 && reps > 0) {
                        sets.push({ weight, reps });
                    }
                }
            }
            
            if (sets.length === 0) {
                alert('Debe haber al menos una serie válida.');
                return;
            }
            
            // Actualizar ejercicio
            exercise.sets = sets;
            
            // Recalcular 1RM
            let estimated1RM = 0;
            sets.forEach(set => {
                if (set.weight > 0 && set.reps >= 1 && set.reps <= 10) {
                    const oneRM = calculate1RM(set.weight, set.reps);
                    if (oneRM && oneRM > estimated1RM) {
                        estimated1RM = oneRM;
                    }
                }
            });
            exercise.estimated1RM = estimated1RM > 0 ? estimated1RM : null;
            
            // Guardar cambios
            localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));
            closeEditModal();
            displayWorkoutHistory();
            updateStats();
            alert('Ejercicio actualizado correctamente.');
        }

        // Guardar edición de descanso
        function saveRestEdit(workoutIndex, exerciseIndex) {
            const duration = parseInt(document.getElementById('editRestDuration').value) || 1;
            
            if (duration < 1 || duration > 60) {
                alert('La duración debe estar entre 1 y 60 minutos.');
                return;
            }
            
            const workout = workoutHistory[workoutIndex];
            workout.exercises[exerciseIndex].sets = [{ weight: 0, reps: duration }];
            
            localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));
            closeEditModal();
            displayWorkoutHistory();
            alert('Descanso actualizado correctamente.');
        }

        // Cerrar modal de edición
        function closeEditModal() {
            const modal = document.getElementById('editModal');
            if (modal) {
                modal.remove();
            }
        }



        // Actualizar estadísticas
        function updateStats() {
            const period = document.getElementById('statsPeriod').value;
            const now = new Date();
            let filteredWorkouts = [];
            
            switch (period) {
                case 'week':
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    filteredWorkouts = workoutHistory.filter(w => new Date(w.startTime) >= weekAgo);
                    break;
                case 'month':
                    const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    filteredWorkouts = workoutHistory.filter(w => new Date(w.startTime) >= monthAgo);
                    break;
                case 'year':
                    const yearAgo = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                    filteredWorkouts = workoutHistory.filter(w => new Date(w.startTime) >= yearAgo);
                    break;
            }
            
            document.getElementById('totalWorkouts').textContent = workoutHistory.length;
            document.getElementById('monthWorkouts').textContent = workoutHistory.filter(w => 
                new Date(w.startTime) >= new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000)
            ).length;
            document.getElementById('weekWorkouts').textContent = workoutHistory.filter(w => 
                new Date(w.startTime) >= new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000)
            ).length;
            
            const totalExercises = workoutHistory.reduce((total, workout) => 
                total + workout.exercises.length, 0
            );
            document.getElementById('totalExercises').textContent = totalExercises;
            
            // Estadísticas de ejercicios (excluyendo descansos)
            const exerciseStats = {};
            const personalRecords = {};
            
            filteredWorkouts.forEach(workout => {
                workout.exercises.forEach(exercise => {
                    // Excluir descansos de las estadísticas
                    if (exercise.name === 'Descanso') return;
                    
                    if (!exerciseStats[exercise.name]) {
                        exerciseStats[exercise.name] = {
                            count: 0,
                            totalWeight: 0,
                            totalReps: 0,
                            maxWeight: 0,
                            max1RM: 0
                        };
                    }
                    
                    exerciseStats[exercise.name].count++;
                    
                    exercise.sets.forEach(set => {
                        exerciseStats[exercise.name].totalWeight += set.weight;
                        exerciseStats[exercise.name].totalReps += set.reps;
                        
                        // Actualizar peso máximo
                        if (set.weight > exerciseStats[exercise.name].maxWeight) {
                            exerciseStats[exercise.name].maxWeight = set.weight;
                        }
                        
                        // Actualizar 1RM máximo
                        if (exercise.estimated1RM && exercise.estimated1RM > exerciseStats[exercise.name].max1RM) {
                            exerciseStats[exercise.name].max1RM = exercise.estimated1RM;
                        }
                    });
                });
            });
            
            const statsContainer = document.getElementById('exerciseStats');
            statsContainer.innerHTML = '<h3>Ejercicios más realizados:</h3>';
            
            Object.entries(exerciseStats)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 5)
                .forEach(([exercise, stats]) => {
                    const avgWeight = stats.totalWeight / stats.count;
                    const avgReps = stats.totalReps / stats.count;
                    
                    // Obtener ratios de peso corporal para este ejercicio
                    const ratios = getBodyWeightRatios(exercise);
                    let ratioInfo = '';
                    
                    if (ratios) {
                        const userWeight = userProfile.weight || 70;
                        ratioInfo = `
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                                    <strong>Ratios recomendados (${userWeight}kg):</strong>
                                </div>
                        `;
                        
                        const levels = ['Beginner', 'Novice', 'Intermediate', 'Advanced', 'Elite'];
                        levels.forEach(level => {
                            if (ratios[level]) {
                                const recommendedWeight = ratios[level].recommendedWeight;
                                const ratio = ratios[level].ratio;
                                const isAchieved = stats.maxWeight >= recommendedWeight;
                                
                                ratioInfo += `
                                    <div style="font-size: 11px; margin: 2px 0; display: flex; justify-content: space-between;">
                                        <span>${level} (${ratio}x):</span>
                                        <span style="${isAchieved ? 'color: #28a745; font-weight: bold;' : 'color: #666;'}">
                                            ${recommendedWeight.toFixed(1)}kg
                                            ${isAchieved ? ' ✓' : ''}
                                        </span>
                                    </div>
                                `;
                            }
                        });
                        
                        ratioInfo += '</div>';
                    }
                    
                    statsContainer.innerHTML += `
                        <div class="exercise-card">
                            <div class="exercise-name">${exercise}</div>
                            <div>Realizado ${stats.count} veces</div>
                            <div>Promedio: ${avgWeight.toFixed(1)}kg x ${avgReps.toFixed(1)} reps</div>
                            <div><strong>Personal Record:</strong> ${stats.maxWeight}kg</div>
                            ${stats.max1RM > 0 ? `<div><strong>1RM máximo:</strong> ${stats.max1RM.toFixed(1)}kg</div>` : ''}
                            ${ratioInfo}
                        </div>
                    `;
                });
        }

        // Calcular 1RM usando fórmula de Brzycki
        function calculate1RM(weight, reps) {
            if (reps >= 1 && reps <= 10) {
                return weight * (36 / (37 - reps));
            }
            return null;
        }

        // Detectar si un ejercicio es de peso corporal
        function isBodyweightExercise(exerciseName) {
            const matchingExercises = exercises.filter(ex => 
                ex.name.toLowerCase() === exerciseName.toLowerCase()
            );
            
            if (matchingExercises.length === 0) {
                return false;
            }
            
            // Si al menos un ejercicio con este nombre tiene equipment "Body Weight", es bodyweight
            return matchingExercises.some(ex => ex.equipment === "Body Weight");
        }

        // Obtener ratios recomendados por peso corporal para un ejercicio
        function getBodyWeightRatios(exerciseName) {
            const userWeight = userProfile.weight || 70; // Default weight if not set
            const userGender = userProfile.gender || 'Male';
            
            // Buscar ejercicios que coincidan con el nombre
            const matchingExercises = exercises.filter(ex => 
                ex.name.toLowerCase() === exerciseName.toLowerCase() && 
                ex.gender === userGender
            );
            
            if (matchingExercises.length === 0) {
                return null;
            }
            
            // Verificar si es un ejercicio de peso corporal
            const isBodyweight = isBodyweightExercise(exerciseName);
            
            // Crear objeto con ratios por nivel
            const ratios = {};
            matchingExercises.forEach(ex => {
                if (isBodyweight) {
                    // Para ejercicios de peso corporal, usar las repeticiones recomendadas
                    const repsStr = ex.reps;
                    if (repsStr && repsStr !== '< 1') {
                        const reps = parseInt(repsStr);
                        if (!isNaN(reps)) {
                            ratios[ex.level] = {
                                recommendedReps: reps,
                                level: ex.level
                            };
                        }
                    }
                } else {
                    // Para ejercicios con peso, usar ratios de peso corporal
                    const ratioStr = ex.reps;
                    if (ratioStr && ratioStr.includes('x')) {
                        const ratio = parseFloat(ratioStr.replace('x', ''));
                        if (!isNaN(ratio)) {
                            ratios[ex.level] = {
                                ratio: ratio,
                                recommendedWeight: ratio * userWeight
                            };
                        }
                    }
                }
            });
            
            return ratios;
        }

        // Añadir objetivo
        function addGoal() {
            const exercise = document.getElementById('goalExercise').value;
            const type = document.getElementById('goalType').value;
            const value = parseFloat(document.getElementById('goalValue').value);
            const trackMe = document.getElementById('trackMe').checked;
            
            if (!exercise) {
                alert('Por favor, selecciona un ejercicio');
                return;
            }
            
            // Determinar el tipo de objetivo basado en el tipo de ejercicio
            let goalType = type;
            if (trackMe) {
                // Para trackMe, determinar automáticamente el tipo basado en el ejercicio
                if (isBodyweightExercise(exercise)) {
                    goalType = 'reps';
                } else {
                    goalType = 'weight';
                }
            } else {
                // Para objetivos manuales, usar el tipo seleccionado
                goalType = type;
            }
            
            // Si trackMe está marcado, no necesitamos valor manual
            if (!trackMe && !value) {
                alert('Por favor, completa todos los campos');
                return;
            }
            
            const goal = {
                id: Date.now(),
                exercise: exercise,
                type: goalType,
                value: trackMe ? 0 : value, // Para trackMe el valor se calcula automáticamente
                trackMe: trackMe,
                completed: false
            };
            
            goals.push(goal);
            localStorage.setItem('goals', JSON.stringify(goals));
            
            // Limpiar formulario
            document.getElementById('goalExercise').value = '';
            document.getElementById('goalValue').value = '';
            document.getElementById('trackMe').checked = false;
            
            displayGoals();
            alert('Objetivo añadido exitosamente!');
        }

        // Cargar objetivos
        function loadGoals() {
            const saved = localStorage.getItem('goals');
            if (saved) {
                goals = JSON.parse(saved);
            }
        }

        // Calcular progreso del objetivo
        function calculateGoalProgress(goal) {
            let currentValue = 0;
            let progress = 0;
            
            // Buscar en el historial el mejor resultado para este ejercicio
            workoutHistory.forEach(workout => {
                workout.exercises.forEach(exercise => {
                    if (exercise.name === goal.exercise) {
                        if (goal.type === 'weight') {
                            // Para objetivos de peso, buscar el 1RM más alto
                            if (exercise.estimated1RM && exercise.estimated1RM > currentValue) {
                                currentValue = exercise.estimated1RM;
                            }
                        } else if (goal.type === 'reps') {
                            // Para objetivos de repeticiones, buscar las reps más altas
                            exercise.sets.forEach(set => {
                                if (set.reps > currentValue) {
                                    currentValue = set.reps;
                                }
                            });
                        } else if (goal.type === 'volume') {
                            // Para objetivos de volumen, sumar todo el volumen
                            exercise.sets.forEach(set => {
                                currentValue += set.weight * set.reps;
                            });
                        }
                    }
                });
            });
            
            if (goal.value > 0) {
                progress = Math.min((currentValue / goal.value) * 100, 100);
            }
            
            return { currentValue, progress };
        }

        // Mostrar objetivos
        function displayGoals() {
            const container = document.getElementById('goalsContainer');
            
            if (goals.length === 0) {
                container.innerHTML = '<p>No hay objetivos establecidos.</p>';
                return;
            }
            
            container.innerHTML = goals.map(goal => {
                const progress = calculateGoalProgress(goal);
                const progressColor = progress.progress >= 100 ? '#28a745' : 
                                   progress.progress >= 75 ? '#ffc107' : 
                                   progress.progress >= 50 ? '#fd7e14' : '#dc3545';
                
                let progressHTML = '';
                
                if (goal.trackMe) {
                    // Mostrar progreso por niveles
                    const ratios = getBodyWeightRatios(goal.exercise);
                    if (ratios) {
                        progressHTML = createLevelProgressHTML(goal, progress, ratios);
                    } else {
                        // Fallback si no hay ratios disponibles
                        progressHTML = createStandardProgressHTML(progress, progressColor);
                    }
                } else {
                    // Mostrar progreso estándar
                    progressHTML = createStandardProgressHTML(progress, progressColor);
                }
                
                return `
                    <div class="exercise-card" style="border-left-color: ${goal.completed ? '#28a745' : progressColor};">
                        <div class="exercise-header">
                            <div class="exercise-name">${goal.exercise}</div>
                            <div style="font-size: 14px; color: #666;">
                                ${goal.type === 'weight' ? '1RM objetivo: ' + goal.value + 'kg' : 
                                  goal.type === 'reps' ? 'Repeticiones objetivo: ' + goal.value : 
                                  'Volumen objetivo: ' + goal.value}
                                ${goal.trackMe ? ' <i class="fas fa-chart-line" style="color: #007bff;"></i>' : ''}
                                ${isBodyweightExercise(goal.exercise) && goal.trackMe ? ' <i class="fas fa-user" style="color: #6f42c1;"></i>' : ''}
                            </div>
                        </div>
                        ${progressHTML}
                        <div style="margin-top: 10px;">
                            <button class="btn btn-success" onclick="markGoalComplete(${goal.id})" ${goal.completed ? 'disabled' : ''}>
                                <i class="fas fa-check"></i> ${goal.completed ? 'Completado' : 'Marcar como completado'}
                            </button>
                            <button class="btn btn-danger" onclick="deleteGoal(${goal.id})">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Crear HTML para progreso estándar
        function createStandardProgressHTML(progress, progressColor) {
            return `
                <div style="margin: 10px 0;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Progreso: ${progress.currentValue.toFixed(1)} / ${progress.value}</span>
                        <span>${progress.progress.toFixed(1)}%</span>
                    </div>
                    <div style="width: 100%; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                        <div style="width: ${progress.progress}%; height: 100%; background: ${progressColor}; transition: width 0.3s ease;"></div>
                    </div>
                </div>
            `;
        }

        // Crear HTML para progreso por niveles
        function createLevelProgressHTML(goal, progress, ratios) {
            const levels = ['Beginner', 'Novice', 'Intermediate', 'Advanced', 'Elite'];
            const levelColors = {
                'Beginner': '#dc3545',
                'Novice': '#fd7e14', 
                'Intermediate': '#ffc107',
                'Advanced': '#28a745',
                'Elite': '#007bff'
            };
            
            let html = '<div style="margin: 10px 0;">';
            
            // Verificar si es un ejercicio de peso corporal
            const isBodyweight = isBodyweightExercise(goal.exercise);
            
            // Encontrar el primer nivel no completado
            let targetLevel = null;
            let targetValue = 0;
            let targetMetric = '';
            
            for (let level of levels) {
                if (ratios[level]) {
                    if (isBodyweight) {
                        const levelValue = ratios[level].recommendedReps;
                        if (progress.currentValue < levelValue) {
                            targetLevel = level;
                            targetValue = levelValue;
                            targetMetric = 'repeticiones';
                            break;
                        }
                    } else {
                        const levelValue = ratios[level].recommendedWeight;
                        const levelRatio = ratios[level].ratio;
                        if (progress.currentValue < levelValue) {
                            targetLevel = level;
                            targetValue = levelValue;
                            targetMetric = 'kg';
                            break;
                        }
                    }
                }
            }
            
            // Si todos los niveles están completados, mostrar el último
            if (!targetLevel) {
                for (let i = levels.length - 1; i >= 0; i--) {
                    const level = levels[i];
                    if (ratios[level]) {
                        targetLevel = level;
                        if (isBodyweight) {
                            targetValue = ratios[level].recommendedReps;
                            targetMetric = 'repeticiones';
                        } else {
                            targetValue = ratios[level].recommendedWeight;
                            targetMetric = 'kg';
                        }
                        break;
                    }
                }
            }
            
            // Mostrar información del objetivo y progreso actual
            if (isBodyweight) {
                html += `
                    <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <div style="font-size: 14px; font-weight: bold; margin-bottom: 8px;">
                            Objetivo: ${targetLevel} (${targetValue} repeticiones)
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            Tu progreso: ${progress.currentValue} repeticiones
                        </div>
                    </div>
                `;
            } else {
                const userWeight = userProfile.weight || 70;
                const currentRatio = progress.currentValue / userWeight;
                const targetRatio = targetValue / userWeight;
                
                html += `
                    <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <div style="font-size: 14px; font-weight: bold; margin-bottom: 8px;">
                            Objetivo: ${targetLevel} (${targetValue.toFixed(1)}kg - ${targetRatio.toFixed(2)}x peso corporal)
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            Tu progreso: ${progress.currentValue.toFixed(1)}kg (${currentRatio.toFixed(2)}x peso corporal)
                        </div>
                    </div>
                `;
            }
            
            // Mostrar solo el nivel objetivo
            if (targetLevel && ratios[targetLevel]) {
                let levelValue, levelProgress, isCompleted;
                
                if (isBodyweight) {
                    levelValue = ratios[targetLevel].recommendedReps;
                    levelProgress = Math.min((progress.currentValue / levelValue) * 100, 100);
                    isCompleted = progress.currentValue >= levelValue;
                } else {
                    levelValue = ratios[targetLevel].recommendedWeight;
                    levelProgress = Math.min((progress.currentValue / levelValue) * 100, 100);
                    isCompleted = progress.currentValue >= levelValue;
                }
                
                html += `
                    <div style="margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                            <span style="font-size: 12px; color: #666;">
                                ${targetLevel} (${isBodyweight ? levelValue + ' reps' : levelValue.toFixed(1) + 'kg'})
                                ${isCompleted ? ' <i class="fas fa-check" style="color: #28a745;"></i>' : ''}
                            </span>
                            <span style="font-size: 12px;">${levelProgress.toFixed(1)}%</span>
                        </div>
                        <div style="width: 100%; height: 6px; background: #e9ecef; border-radius: 3px; overflow: hidden;">
                            <div style="width: ${levelProgress}%; height: 100%; background: ${levelColors[targetLevel]}; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        // Marcar objetivo como completado
        function markGoalComplete(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (goal) {
                goal.completed = true;
                localStorage.setItem('goals', JSON.stringify(goals));
                displayGoals();
            }
        }

        // Eliminar objetivo
        function deleteGoal(goalId) {
            goals = goals.filter(g => g.id !== goalId);
            localStorage.setItem('goals', JSON.stringify(goals));
            displayGoals();
        }

        // Manejar cambios en el checkbox "track me"
        document.getElementById('trackMe').addEventListener('change', function() {
            const goalTypeGroup = document.getElementById('goalType').closest('.form-group');
            const goalValueGroup = document.getElementById('goalValue').closest('.form-group');
            
            if (this.checked) {
                goalTypeGroup.style.display = 'none';
                goalValueGroup.style.display = 'none';
            } else {
                goalTypeGroup.style.display = 'block';
                goalValueGroup.style.display = 'block';
            }
        });

        // Búsqueda de ejercicios para objetivos
        document.getElementById('goalExercise').addEventListener('input', function() {
            const searchTerm = this.value;
            const bodyPartFilter = document.getElementById('goalBodyPartFilter').value;
            const equipmentFilter = document.getElementById('goalEquipmentFilter').value;
            const dropdown = document.getElementById('goalExerciseDropdown');
            
            const uniqueExercises = filterExercises(searchTerm, bodyPartFilter, equipmentFilter, exercises);

            dropdown.innerHTML = '';
            uniqueExercises.forEach(exercise => {
                const option = document.createElement('div');
                option.className = 'exercise-option';
                option.innerHTML = `
                    <img src="${exercise.image}" alt="${exercise.name}" onerror="this.src='https://via.placeholder.com/40x40?text=?'">
                    <div>
                        <div><strong>${exercise.name}</strong></div>
                        <div style="font-size: 12px; color: #666;">${exercise.bodyPart} - ${exercise.equipment}</div>
                    </div>
                `;
                option.onclick = () => {
                    document.getElementById('goalExercise').value = exercise.name;
                    dropdown.style.display = 'none';
                };
                dropdown.appendChild(option);
            });
            
            dropdown.style.display = uniqueExercises.length > 0 ? 'block' : 'none';
        });

        // Event listeners para los filtros de objetivos
        document.getElementById('goalBodyPartFilter').addEventListener('change', function() {
            const searchTerm = document.getElementById('goalExercise').value;
            const equipmentFilter = document.getElementById('goalEquipmentFilter').value;
            const dropdown = document.getElementById('goalExerciseDropdown');
            
            const uniqueExercises = filterExercises(searchTerm, this.value, equipmentFilter, exercises);

            dropdown.innerHTML = '';
            uniqueExercises.forEach(exercise => {
                const option = document.createElement('div');
                option.className = 'exercise-option';
                option.innerHTML = `
                    <img src="${exercise.image}" alt="${exercise.name}" onerror="this.src='https://via.placeholder.com/40x40?text=?'">
                    <div>
                        <div><strong>${exercise.name}</strong></div>
                        <div style="font-size: 12px; color: #666;">${exercise.bodyPart} - ${exercise.equipment}</div>
                    </div>
                `;
                option.onclick = () => {
                    document.getElementById('goalExercise').value = exercise.name;
                    dropdown.style.display = 'none';
                };
                dropdown.appendChild(option);
            });
            
            dropdown.style.display = uniqueExercises.length > 0 ? 'block' : 'none';
        });

        document.getElementById('goalEquipmentFilter').addEventListener('change', function() {
            const searchTerm = document.getElementById('goalExercise').value;
            const bodyPartFilter = document.getElementById('goalBodyPartFilter').value;
            const dropdown = document.getElementById('goalExerciseDropdown');
            
            const uniqueExercises = filterExercises(searchTerm, bodyPartFilter, this.value, exercises);

            dropdown.innerHTML = '';
            uniqueExercises.forEach(exercise => {
                const option = document.createElement('div');
                option.className = 'exercise-option';
                option.innerHTML = `
                    <img src="${exercise.image}" alt="${exercise.name}" onerror="this.src='https://via.placeholder.com/40x40?text=?'">
                    <div>
                        <div><strong>${exercise.name}</strong></div>
                        <div style="font-size: 12px; color: #666;">${exercise.bodyPart} - ${exercise.equipment}</div>
                    </div>
                `;
                option.onclick = () => {
                    document.getElementById('goalExercise').value = exercise.name;
                    dropdown.style.display = 'none';
                };
                dropdown.appendChild(option);
            });
            
            dropdown.style.display = uniqueExercises.length > 0 ? 'block' : 'none';
        });
    </script>
</body>
</html>
